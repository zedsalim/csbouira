import{API_KEYS}from"./apikeys.js";const cloudinaryConfig={cloudName:"deoltrk6v",uploadPreset:"csb_upload"};document.getElementById("form").addEventListener("submit",async e=>{e.preventDefault();const t=e.target,a=new FormData(t),n=t.querySelector("#uploadfile"),o=n.files,s=document.getElementById("response"),l=document.getElementById("submit-upload"),r=document.getElementById("spinnerHidden"),d=document.getElementById("alerts");s.innerHTML="",d.innerHTML="",l.disabled=!0,r.style.display="inline-block";if(0===o.length)return d.innerHTML=`<div class="alert alert-warning" role="alert">لم تختر الملفات التي تريد رفعها</div>`,l.disabled=!1,r.style.display="none",void 0;let i=0,c=[];for(const e of o){let t="raw";e.type.startsWith("image/")?t="image":e.type.startsWith("video/")&&(t="video");const a=document.createElement("div");a.className="progress my-1";const n=document.createElement("div");n.className="progress-bar",n.setAttribute("role","progressbar"),n.setAttribute("aria-valuemin","0"),n.setAttribute("aria-valuemax","100"),n.style.width="0%",a.appendChild(n),s.appendChild(a),await new Promise(o=>{const s=new XMLHttpRequest;s.open("POST",`https://api.cloudinary.com/v1_1/${cloudinaryConfig.cloudName}/${t}/upload`),s.upload.onprogress=t=>{if(t.lengthComputable){const a=t.loaded/t.total*100;n.style.width=`${a}%`,n.setAttribute("aria-valuenow",a.toFixed(0))}},s.onload=()=>{if(200===s.status){const t=JSON.parse(s.responseText);t.secure_url?(c.push({name:e.name,url:t.secure_url}),d.innerHTML=`<div class="alert alert-success" role="alert">تم رفع الملف "${e.name}" بنجاح!</div>`):d.innerHTML+=`<div class="alert alert-danger">فشل رفع ${e.name}: ${t.error?.message||"خطأ غير معروف"}</div>`}else d.innerHTML+=`<div class="alert alert-danger">فشل رفع ${e.name}</div>`;o()},s.onerror=()=>{d.innerHTML+=`<div class="alert alert-danger">خطأ في رفع ${e.name}</div>`,o()};const l=new FormData;l.append("file",e),l.append("upload_preset",cloudinaryConfig.uploadPreset),s.send(l)}),i++}if(i===o.length&&(s.innerHTML=""),i===o.length){const e=new FormData;e.append("name",a.get("name")),e.append("email",a.get("email")),e.append("module",a.get("module")),e.append("filetype",a.get("filetype")),e.append("grade",a.get("grade")),e.append("semestre",a.get("semestre")),e.append("fileLinks",JSON.stringify(c));try{const t=await fetch(API_KEYS.FILE_UPLOAD,{method:"POST",body:e});if(!t.ok)throw new Error(`HTTP error! status: ${t.status}`);d.innerHTML=`<div class="alert alert-success" role="alert">تم رفع جميع الملفات بنجاح! شكرا.</div>`,n.value=""}catch(e){d.innerHTML=`<div class="alert alert-danger" role="alert">خطأ في إرسال البيانات. يرجى المحاولة مرة أخرى. ${e.message}</div>`}}l.disabled=!1,r.style.display="none"});
