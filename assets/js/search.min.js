const SEARCH_API="https://api.csbouira.xyz/api/drive";let searchIndex=[],searchDataCache=null,searchDebounceTimer=null,isSearchIndexing=!1;const fetchSearchData=async()=>{if(searchDataCache)return searchDataCache;const e=await fetch(SEARCH_API);return searchDataCache=await e.json(),searchDataCache},buildSearchIndex=e=>{const t=[],a=(e,n,s)=>{if(e.subfolders&&"object"==typeof e.subfolders)for(const[r,l]of Object.entries(e.subfolders)){if(r.includes("(empty)"))continue;const e=[...s,r],i=extractMeta(e);t.push({type:"folder",name:r,year:n,semester:i.semester,module:i.module,resourceType:i.resourceType,path:e,apiPath:[n,...e].join(">subfolders>"),link:l.link||""}),a(l,n,e)}if(e.files&&Array.isArray(e.files))for(const a of e.files){const e=extractMeta(s);t.push({type:"file",name:a.name,year:n,semester:e.semester,module:e.module,resourceType:e.resourceType,path:s,apiPath:[n,...s].join(">subfolders>"),link:a.link||"",previewLink:a.previewLink||"",downloadLink:a.downloadLink||""})}};for(const[t,n]of Object.entries(e))t.startsWith("_")||"object"==typeof n&&null!==n&&a(n,t,[]);return t},extractMeta=e=>({semester:e.length>=1?e[0]:"",module:e.length>=2?e[1]:"",resourceType:e.length>=3?e[2]:""}),performSearch=(e,t)=>{let a=[...searchIndex];if(e&&e.trim()){const t=e.trim().toLowerCase();a=a.filter(e=>e.name.toLowerCase().includes(t)||e.module&&e.module.toLowerCase().includes(t)||e.year&&e.year.toLowerCase().includes(t))}return t.year&&(a=a.filter(e=>e.year===t.year)),t.semester&&(a=a.filter(e=>{const a=parseInt(e.semester.replace(/\D/g,""),10);return!isNaN(a)&&("S1"===t.semester?a%2==1:"S2"===t.semester&&a%2==0)})),t.resourceType&&(a=a.filter(e=>{const a=e.resourceType.toLowerCase(),n=t.resourceType.toLowerCase();return a.includes(n)||"folder"===e.type&&e.name.toLowerCase().includes(n)})),a},openSearchModal=async()=>{if(document.getElementById("searchModal").classList.add("active"),updateBodyScrollLock(),setTimeout(()=>{document.getElementById("searchInput").focus()},100),0===searchIndex.length&&!isSearchIndexing){isSearchIndexing=!0;const e=document.getElementById("searchResults");e.innerHTML='\n      <div class="text-center py-8">\n        <div class="loading mx-auto"></div>\n        <p class="mt-4">Loading resources index...</p>\n      </div>\n    ';try{const t=await fetchSearchData();searchIndex=buildSearchIndex(t),e.innerHTML='\n        <div class="empty-state">\n          <i class="fas fa-search text-6xl mb-4" style="color: var(--text-secondary-light);"></i>\n          <p class="text-xl">Search across all resources</p>\n          <p class="mt-2 text-sm" style="color: var(--text-secondary-light);">\n            Type a filename, module, or keyword to find resources\n          </p>\n        </div>\n      '}catch(t){e.innerHTML=`\n        <div class="empty-state">\n          <i class="fas fa-exclamation-circle text-6xl text-red-500 mb-4"></i>\n          <p class="text-xl">Error loading search index</p>\n          <p class="mt-2">${t.message}</p>\n        </div>\n      `}finally{isSearchIndexing=!1}}},closeSearchModal=()=>{document.getElementById("searchModal").classList.remove("active"),updateBodyScrollLock()},getSearchFilters=()=>({year:document.getElementById("searchFilterYear").value,semester:document.getElementById("searchFilterSemester").value,resourceType:document.getElementById("searchFilterType").value}),triggerSearch=()=>{const e=document.getElementById("searchInput").value,t=getSearchFilters();if(!(e.trim()||t.year||t.semester||t.resourceType))return document.getElementById("searchResults").innerHTML='\n      <div class="empty-state">\n        <i class="fas fa-search text-6xl mb-4" style="color: var(--text-secondary-light);"></i>\n        <p class="text-xl">Search across all resources</p>\n        <p class="mt-2 text-sm" style="color: var(--text-secondary-light);">\n          Type a filename, module, or keyword to find resources\n        </p>\n      </div>\n    ',void(document.getElementById("searchResultCount").textContent="");const a=performSearch(e,t);renderSearchResults(a,e)},renderSearchResults=(e,t)=>{const a=document.getElementById("searchResults"),n=document.getElementById("searchResultCount");if(0===e.length)return a.innerHTML='\n      <div class="empty-state">\n        <i class="fas fa-search text-6xl mb-4" style="color: var(--text-secondary-light);"></i>\n        <p class="text-xl">No results found</p>\n        <p class="mt-2 text-sm" style="color: var(--text-secondary-light);">Try different keywords or adjust your filters</p>\n      </div>\n    ',void(n.textContent="0 results");const s=e.slice(0,100);n.textContent=`${e.length} result${1!==e.length?"s":""}${e.length>100?" (showing first 100)":""}`;let r='<div class="space-y-2">';for(const e of s){const a="folder"===e.type?"fas fa-folder text-yellow-500":getSearchFileIcon(e.name),n=highlightMatch(e.name,t),s=[e.year,...e.path].join(" â€º ");if("file"===e.type){r+=`\n        <div class="file-item search-result-item group">\n          <div class="flex items-center gap-3 flex-1 min-w-0" onclick='openSearchFile(${JSON.stringify({name:e.name,link:e.link,previewLink:e.previewLink,downloadLink:e.downloadLink}).replace(/'/g,"&apos;")})'>\n            <i class="${a} flex-shrink-0"></i>\n            <div class="flex-1 min-w-0">\n              <span class="block truncate">${n}</span>\n              <span class="block text-xs mt-0.5 truncate" style="color: var(--text-secondary-light);">${s}</span>\n            </div>\n            <i class="action-btn fas fa-eye flex-shrink-0"></i>\n          </div>\n          ${e.downloadLink?`\n            <button \n              onclick='event.stopPropagation(); downloadFile("${e.downloadLink}", "${e.name.replace(/'/g,"&apos;")}")' \n              class="action-btn ml-2 flex-shrink-0"\n              title="Download file">\n              <i class="fas fa-download"></i>\n            </button>\n          `:""}\n        </div>\n      `}else{r+=`\n        <div class="folder-item search-result-item" onclick='openSearchFolder(${JSON.stringify({year:e.year,path:e.path,apiPath:e.apiPath}).replace(/'/g,"&apos;")})'>\n          <i class="${a} flex-shrink-0"></i>\n          <div class="flex-1 min-w-0">\n            <span class="block truncate">${n}</span>\n            <span class="block text-xs mt-0.5 truncate" style="color: var(--text-secondary-light);">${s}</span>\n          </div>\n          <i class="fas fa-chevron-right flex-shrink-0"></i>\n        </div>\n      `}}r+="</div>",a.innerHTML=r},openSearchFile=e=>{e.previewLink?(document.getElementById("modalTitle").textContent=e.name,document.getElementById("fileViewer").src=e.previewLink,document.getElementById("fileModal").classList.add("active"),updateBodyScrollLock()):e.link&&window.open(e.link,"_blank")},openSearchFolder=async e=>{currentYear=e.year,currentPath=[e.year,...e.path];document.getElementById("yearModalTitle").innerHTML=`\n    <div class="flex items-center gap-3">\n      <span class="text-xl font-semibold">${e.year}</span>\n      <a \n        href="#" \n        id="driveLink" \n        title="Open in Google Drive"\n        class="hidden sm:inline-flex items-center gap-1.5 \n               px-2.5 py-1 text-xs \n               sm:gap-2 sm:px-3 sm:py-1.5 sm:text-sm\n               rounded-md bg-blue-500\n               text-white font-medium shadow-md\n               hover:shadow-lg hover:opacity-90 transition-all duration-200"\n      >\n        <i class="fab fa-google-drive text-base sm:text-lg"></i>\n        <span class="hidden xs:inline sm:inline">Open in Drive</span>\n      </a>\n    </div>\n  `,document.getElementById("yearModal").classList.add("active"),updateBodyScrollLock(),await loadContent(currentYear,e.apiPath)},highlightMatch=(e,t)=>{if(!t||!t.trim())return e;const a=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),n=new RegExp(`(${a})`,"gi");return e.replace(n,'<mark class="search-highlight">$1</mark>')},getSearchFileIcon=e=>({pdf:"fas fa-file-pdf text-red-500",doc:"fas fa-file-word text-blue-600",docx:"fas fa-file-word text-blue-600",ppt:"fas fa-file-powerpoint text-orange-500",pptx:"fas fa-file-powerpoint text-orange-500",xls:"fas fa-file-excel text-green-500",xlsx:"fas fa-file-excel text-green-500",zip:"fas fa-file-archive text-purple-500",rar:"fas fa-file-archive text-purple-500",png:"fas fa-file-image text-yellow-500",jpg:"fas fa-file-image text-yellow-500",jpeg:"fas fa-file-image text-yellow-500",txt:"fas fa-file-alt text-gray-500",py:"fab fa-python text-blue-500",js:"fab fa-js-square text-yellow-400",c:"fas fa-file-code text-blue-400",cpp:"fas fa-file-code text-blue-400"}[(e||"").split(".").pop().toLowerCase()]||"fas fa-file text-gray-500");document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("searchInput");e&&(e.addEventListener("input",()=>{clearTimeout(searchDebounceTimer),searchDebounceTimer=setTimeout(triggerSearch,300)}),e.addEventListener("keydown",e=>{"Enter"===e.key&&(clearTimeout(searchDebounceTimer),triggerSearch())})),["searchFilterYear","searchFilterSemester","searchFilterType"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",triggerSearch)})});