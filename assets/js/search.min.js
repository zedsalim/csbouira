const SEARCH_API="https://api.csbouira.xyz/api/drive";let searchIndex=[],searchDataCache=null,searchDebounceTimer=null,isSearchIndexing=!1,allModules=[];const fetchSearchData=async()=>{if(searchDataCache)return searchDataCache;const e=await fetch(SEARCH_API);return searchDataCache=await e.json(),searchDataCache},buildSearchIndex=e=>{const t=[],s=(e,n,r)=>{if(e.subfolders&&"object"==typeof e.subfolders)for(const[a,o]of Object.entries(e.subfolders)){if(a.includes("(empty)"))continue;const e=[...r,a],l=extractMeta(e);t.push({type:"folder",name:a,year:n,semester:l.semester,module:l.module,resourceType:l.resourceType,path:e,apiPath:[n,...e].join(">subfolders>"),link:o.link||""}),s(o,n,e)}if(e.files&&Array.isArray(e.files))for(const s of e.files){const e=extractMeta(r);t.push({type:"file",name:s.name,year:n,semester:e.semester,module:e.module,resourceType:e.resourceType,path:r,apiPath:[n,...r].join(">subfolders>"),link:s.link||"",previewLink:s.previewLink||"",downloadLink:s.downloadLink||""})}};for(const[t,n]of Object.entries(e))t.startsWith("_")||"object"==typeof n&&null!==n&&s(n,t,[]);return t},extractMeta=e=>({semester:e.length>=1?e[0]:"",module:e.length>=2?e[1]:"",resourceType:e.length>=3?e[2]:""}),RESOURCE_TYPE_NAMES=new Set(["cours","exams","exam","tests","test","tds","tps","tds & tps","td","tp","résumé","resume","résumés","books & exercices","books","exercices"]),extractModulesFromData=e=>{const t=new Map;for(const[s,n]of Object.entries(e))if(!s.startsWith("_")&&"object"==typeof n&&null!==n&&n.subfolders)for(const[e,r]of Object.entries(n.subfolders))if(/^S\d/i.test(e)&&r.subfolders)for(const n of Object.keys(r.subfolders)){if(n.includes("(empty)"))continue;const r=n.trim().toLowerCase();RESOURCE_TYPE_NAMES.has(r)||(n.trim().length<3||t.has(r)||t.set(r,{name:n.trim(),year:s,semester:e}))}return Array.from(t.values())},populateModuleFilter=(e={})=>{const t=document.getElementById("searchFilterModule");if(!t)return;const s=t.value;let n=allModules;e.year&&(n=n.filter(t=>t.year===e.year)),e.semester&&(n=n.filter(t=>{const s=parseInt(t.semester.replace(/\D/g,""),10);return!isNaN(s)&&("S1"===e.semester?s%2==1:"S2"===e.semester&&s%2==0)})),t.innerHTML='<option value="">All Modules</option>';for(const e of n){const s=document.createElement("option");s.value=e.name,s.textContent=e.name,t.appendChild(s)}[...t.options].some(e=>e.value===s)&&(t.value=s)},levenshtein=(e,t)=>{const s=e.length,n=t.length;if(0===s)return n;if(0===n)return s;let r=Array.from({length:n+1},(e,t)=>t),a=new Array(n+1);for(let o=1;o<=s;o++){a[0]=o;for(let s=1;s<=n;s++){const n=e[o-1]===t[s-1]?0:1;a[s]=Math.min(r[s]+1,a[s-1]+1,r[s-1]+n)}[r,a]=[a,r]}return r[n]},fuzzyMatch=(e,t,s=2)=>{const n=e.toLowerCase(),r=t.toLowerCase();if(n.includes(r))return!0;if(r.length<=2)return!1;const a=r.length;for(let e=0;e<=n.length-a+s;e++){const t=Math.min(e+a+s,n.length),o=n.slice(e,t);if(levenshtein(o,r)<=s)return!0}const o=n.split(/[\s\-_.,()]+/);for(const e of o)if(e.length>0&&levenshtein(e,r)<=s)return!0;return!1},scoreItem=(e,t)=>{let s=0;const n=e.name.toLowerCase(),r=(e.module||"").toLowerCase(),a=(e.year||"").toLowerCase(),o=(e.resourceType||"").toLowerCase(),l=e.path.join(" ").toLowerCase();for(const e of t){const t=e.toLowerCase();let c=!1;if(n===t?(s+=15,c=!0):n.startsWith(t)?(s+=10,c=!0):n.includes(t)&&(s+=5,c=!0),r.includes(t)&&(s+=4,c=!0),a.includes(t)&&(s+=2,c=!0),o.includes(t)&&(s+=2,c=!0),!c&&l.includes(t)&&(s+=1,c=!0),!c){const e=[n,r,a,o,l];for(const n of e)if(n&&fuzzyMatch(n,t)){s+=.5;break}}}return"file"===e.type&&(s+=.1),s},tokenizeQuery=e=>e&&e.trim()?e.trim().split(/\s+/).filter(e=>e.length>0):[],itemMatchesTokens=(e,t)=>{const s=e.name.toLowerCase(),n=(e.module||"").toLowerCase(),r=(e.year||"").toLowerCase(),a=(e.resourceType||"").toLowerCase(),o=e.path.join(" ").toLowerCase();for(const e of t){const t=e.toLowerCase();if(s.includes(t)||n.includes(t)||r.includes(t)||a.includes(t)||o.includes(t))continue;const l=[s,n,r,a,o];let c=!1;for(const e of l)if(e&&fuzzyMatch(e,t)){c=!0;break}if(!c)return!1}return!0},performSearch=(e,t)=>{let s=[...searchIndex];t.year&&(s=s.filter(e=>e.year===t.year)),t.semester&&(s=s.filter(e=>{const s=parseInt(e.semester.replace(/\D/g,""),10);return!isNaN(s)&&("S1"===t.semester?s%2==1:"S2"===t.semester&&s%2==0)})),t.module&&(s=s.filter(e=>e.module&&e.module.toLowerCase().includes(t.module.toLowerCase()))),t.resourceType&&(s=s.filter(e=>{const s=e.resourceType.toLowerCase(),n=t.resourceType.toLowerCase();return s.includes(n)||"folder"===e.type&&e.name.toLowerCase().includes(n)}));const n=tokenizeQuery(e);return n.length>0&&(s=s.filter(e=>itemMatchesTokens(e,n)),s=s.map(e=>({...e,_score:scoreItem(e,n)})).sort((e,t)=>t._score-e._score)),s},openSearchModal=async()=>{if(document.getElementById("searchModal").classList.add("active"),updateBodyScrollLock(),setTimeout(()=>{document.getElementById("searchInput").focus()},100),0===searchIndex.length&&!isSearchIndexing){isSearchIndexing=!0;const e=document.getElementById("searchResults");e.innerHTML='\n      <div class="text-center py-8">\n        <div class="loading mx-auto"></div>\n        <p class="mt-4">Loading resources index...</p>\n      </div>\n    ';try{const t=await fetchSearchData();searchIndex=buildSearchIndex(t),allModules=extractModulesFromData(t),populateModuleFilter(),e.innerHTML='\n        <div class="empty-state">\n          <i class="fas fa-search text-6xl mb-4" style="color: var(--text-secondary-light);"></i>\n          <p class="text-xl">Search across all resources</p>\n          <p class="mt-2 text-sm" style="color: var(--text-secondary-light);">\n            Multi-word search supported — e.g. "algo exam" finds results matching both words\n          </p>\n        </div>\n      '}catch(t){e.innerHTML=`\n        <div class="empty-state">\n          <i class="fas fa-exclamation-circle text-6xl text-red-500 mb-4"></i>\n          <p class="text-xl">Error loading search index</p>\n          <p class="mt-2">${t.message}</p>\n        </div>\n      `}finally{isSearchIndexing=!1}}},closeSearchModal=()=>{document.getElementById("searchModal").classList.remove("active"),updateBodyScrollLock()},getSearchFilters=()=>({year:document.getElementById("searchFilterYear").value,semester:document.getElementById("searchFilterSemester").value,resourceType:document.getElementById("searchFilterType").value,module:document.getElementById("searchFilterModule")?document.getElementById("searchFilterModule").value:""}),triggerSearch=()=>{const e=document.getElementById("searchInput").value,t=getSearchFilters();if(!(e.trim()||t.year||t.semester||t.resourceType||t.module))return document.getElementById("searchResults").innerHTML='\n      <div class="empty-state">\n        <i class="fas fa-search text-6xl mb-4" style="color: var(--text-secondary-light);"></i>\n        <p class="text-xl">Search across all resources</p>\n        <p class="mt-2 text-sm" style="color: var(--text-secondary-light);">\n          Multi-word search supported — e.g. "algo exam" finds results matching both words\n        </p>\n      </div>\n    ',void(document.getElementById("searchResultCount").textContent="");const s=performSearch(e,t);renderSearchResults(s,e)},renderSearchResults=(e,t)=>{const s=document.getElementById("searchResults"),n=document.getElementById("searchResultCount");if(0===e.length){const e=tokenizeQuery(t).some(e=>e.length>3);return s.innerHTML=`\n      <div class="empty-state">\n        <i class="fas fa-search text-6xl mb-4" style="color: var(--text-secondary-light);"></i>\n        <p class="text-xl">No results found</p>\n        <p class="mt-2 text-sm" style="color: var(--text-secondary-light);">\n          ${e?"Fuzzy matching was applied but no matches were found. ":""}Try different keywords or adjust your filters\n        </p>\n      </div>\n    `,void(n.textContent="0 results")}const r=e.slice(0,100);n.textContent=`${e.length} result${1!==e.length?"s":""}${e.length>100?" (showing first 100)":""}`;let a='<div class="space-y-2">';for(const e of r){const s="folder"===e.type?"fas fa-folder text-yellow-500":getSearchFileIcon(e.name),n=highlightMatch(e.name,t),r=[e.year,...e.path].join(" › "),o=e.module?`<span class="search-module-badge">${e.module}</span>`:"";if("file"===e.type){a+=`\n        <div class="file-item search-result-item group">\n          <div class="flex items-center gap-3 flex-1 min-w-0" onclick='openSearchFile(${JSON.stringify({name:e.name,link:e.link,previewLink:e.previewLink,downloadLink:e.downloadLink}).replace(/'/g,"&apos;")})'>\n            <i class="${s} flex-shrink-0"></i>\n            <div class="flex-1 min-w-0">\n              <span class="block truncate">${n}</span>\n              <span class="block text-xs mt-0.5 truncate" style="color: var(--text-secondary-light);">${r}</span>\n              ${o}\n            </div>\n            <i class="action-btn fas fa-eye flex-shrink-0"></i>\n          </div>\n          ${e.downloadLink?`\n            <button \n              onclick='event.stopPropagation(); downloadFile("${e.downloadLink}", "${e.name.replace(/'/g,"&apos;")}")' \n              class="action-btn ml-2 flex-shrink-0"\n              title="Download file">\n              <i class="fas fa-download"></i>\n            </button>\n          `:""}\n        </div>\n      `}else{a+=`\n        <div class="folder-item search-result-item" onclick='openSearchFolder(${JSON.stringify({year:e.year,path:e.path,apiPath:e.apiPath}).replace(/'/g,"&apos;")})'>\n          <i class="${s} flex-shrink-0"></i>\n          <div class="flex-1 min-w-0">\n            <span class="block truncate">${n}</span>\n            <span class="block text-xs mt-0.5 truncate" style="color: var(--text-secondary-light);">${r}</span>\n            ${o}\n          </div>\n          <i class="fas fa-chevron-right flex-shrink-0"></i>\n        </div>\n      `}}a+="</div>",s.innerHTML=a},openSearchFile=e=>{e.previewLink?(document.getElementById("modalTitle").textContent=e.name,document.getElementById("fileViewer").src=e.previewLink,document.getElementById("fileModal").classList.add("active"),updateBodyScrollLock()):e.link&&window.open(e.link,"_blank")},openSearchFolder=async e=>{currentYear=e.year,currentPath=[e.year,...e.path];document.getElementById("yearModalTitle").innerHTML=`\n    <div class="flex items-center gap-3">\n      <span class="text-xl font-semibold">${e.year}</span>\n      <a \n        href="#" \n        id="driveLink" \n        title="Open in Google Drive"\n        class="hidden sm:inline-flex items-center gap-1.5 \n               px-2.5 py-1 text-xs \n               sm:gap-2 sm:px-3 sm:py-1.5 sm:text-sm\n               rounded-md bg-blue-500\n               text-white font-medium shadow-md\n               hover:shadow-lg hover:opacity-90 transition-all duration-200"\n      >\n        <i class="fab fa-google-drive text-base sm:text-lg"></i>\n        <span class="hidden xs:inline sm:inline">Open in Drive</span>\n      </a>\n    </div>\n  `,document.getElementById("yearModal").classList.add("active"),updateBodyScrollLock(),await loadContent(currentYear,e.apiPath)},highlightMatch=(e,t)=>{if(!t||!t.trim())return e;const s=tokenizeQuery(t);let n=e;for(const e of s){const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),s=new RegExp(`(${t})`,"gi");n=n.replace(s,'<mark class="search-highlight">$1</mark>')}return n},getSearchFileIcon=e=>({pdf:"fas fa-file-pdf text-red-500",doc:"fas fa-file-word text-blue-600",docx:"fas fa-file-word text-blue-600",ppt:"fas fa-file-powerpoint text-orange-500",pptx:"fas fa-file-powerpoint text-orange-500",xls:"fas fa-file-excel text-green-500",xlsx:"fas fa-file-excel text-green-500",zip:"fas fa-file-archive text-purple-500",rar:"fas fa-file-archive text-purple-500",png:"fas fa-file-image text-yellow-500",jpg:"fas fa-file-image text-yellow-500",jpeg:"fas fa-file-image text-yellow-500",txt:"fas fa-file-alt text-gray-500",py:"fab fa-python text-blue-500",js:"fab fa-js-square text-yellow-400",c:"fas fa-file-code text-blue-400",cpp:"fas fa-file-code text-blue-400"}[(e||"").split(".").pop().toLowerCase()]||"fas fa-file text-gray-500");document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("searchInput");e&&(e.addEventListener("input",()=>{clearTimeout(searchDebounceTimer),searchDebounceTimer=setTimeout(triggerSearch,300)}),e.addEventListener("keydown",e=>{"Enter"===e.key&&(clearTimeout(searchDebounceTimer),triggerSearch())})),["searchFilterYear","searchFilterSemester"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",()=>{populateModuleFilter(getSearchFilters()),triggerSearch()})}),["searchFilterType","searchFilterModule"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("change",triggerSearch)})});