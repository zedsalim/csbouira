const GAS_UPLOAD_URL="https://script.google.com/macros/s/AKfycbxMikLNPWYBEWjYJ7FSLJAHV_dZ_5E6aSGarqtm7kubMsjzXFHXnW4s-eEM2RtFOaF3/exec";let selectedFiles=[],isUploading=!1;const openUploadModal=()=>{document.getElementById("uploadModal").classList.add("active"),updateBodyScrollLock()},closeUploadModal=()=>{document.getElementById("uploadModal").classList.remove("active"),updateBodyScrollLock(),document.getElementById("uploadForm").reset(),selectedFiles=[],displayFilesList();let e=document.getElementById("uploadProgress");e&&(e.innerHTML="",e.classList.add("hidden"))},initUploadForm=()=>{let e=document.getElementById("uploadForm"),t=document.getElementById("submitBtn"),s=document.getElementById("uploadLoading"),l=document.getElementById("uploadResponseMessage"),d=document.getElementById("files"),a=document.getElementById("filesList");e&&(d.addEventListener("change",e=>{let t=Array.from(e.target.files);selectedFiles=t,displayFilesList()}),e.addEventListener("submit",async d=>{if(d.preventDefault(),isUploading)return;let r=document.getElementById("fullName").value.trim(),i=document.getElementById("uploadEmail").value.trim(),o=document.getElementById("fileType").value,n=document.getElementById("moduleName").value.trim(),$=document.getElementById("grade").value,g=document.getElementById("semester").value,m=selectedFiles;if(!r||!i||!o||!n||!$||!g||0===m.length){showUploadMessage("Please fill in all fields and select at least one file","error");return}let c=m.filter(e=>e.size>26214400);if(c.length>0){showUploadMessage(`The following files exceed 25MB limit: ${c.map(e=>e.name).join(", ")}`,"error");return}isUploading=!0,t.disabled=!0,s.classList.remove("hidden"),s.classList.add("flex"),l.classList.add("hidden");let p=document.getElementById("uploadProgress");p.innerHTML="",p.classList.remove("hidden"),setTimeout(()=>{p.scrollIntoView({behavior:"smooth",block:"start"})},100);let u=`
      <h4 class="font-semibold mb-3 text-sm">Upload Progress:</h4>
      ${m.map((e,t)=>`
        <div class="mb-3 p-3 bg-gray-50 dark:bg-gray-800 rounded-md" id="progress-${t}">
          <div class="text-sm font-medium mb-2 truncate" title="${e.name}">${e.name}</div>
          <div class="w-full h-5 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
            <div class="h-full bg-blue-500 flex items-center justify-center text-white text-xs font-semibold transition-all duration-300" id="progress-bar-${t}" style="width: 0%">0%</div>
          </div>
          <div class="text-xs mt-1 text-gray-600 dark:text-gray-400" id="status-${t}">Waiting...</div>
        </div>
      `).join("")}
    `;p.innerHTML=u;let y=0,f=0,b=[];for(let L=0;L<m.length;L++){let h=m[L];updateUploadProgress(L,10,"Reading file...");try{let x=await readFileAsBase64(h);updateUploadProgress(L,30,"Preparing upload...");let v={fullName:r,email:i,fileType:o,moduleName:n,grade:$,semester:g,fileName:h.name,fileData:x,mimeType:h.type,sendEmail:!1};updateUploadProgress(L,50,"Uploading to server...");let E=await fetch(GAS_UPLOAD_URL,{method:"POST",body:JSON.stringify(v)});updateUploadProgress(L,80,"Processing response...");let U=await E.json();"success"===U.status?(updateUploadProgress(L,100,"✓ Upload successful",!0),y++,b.push({name:U.fileName||h.name,url:U.fileUrl||""})):(updateUploadProgress(L,100,"✗ "+U.message,!1),f++)}catch(B){updateUploadProgress(L,100,"✗ Upload failed",!1),f++}L<m.length-1&&await new Promise(e=>setTimeout(e,500))}if(y>0)try{await sendSummaryEmail(r,i,o,n,$,g,b)}catch(F){}isUploading=!1,t.disabled=!1,s.classList.add("hidden"),s.classList.remove("flex"),y===m.length?(showUploadMessage(`✓ All ${y} file(s) uploaded successfully!`,"success"),e.reset(),selectedFiles=[],a.classList.add("hidden"),a.innerHTML="",setTimeout(()=>{p.classList.add("hidden")},5e3)):y>0?showUploadMessage(`⚠ ${y} file(s) uploaded, ${f} failed`,"error"):showUploadMessage("✗ All uploads failed. Please try again.","error")}))},displayFilesList=()=>{let e=document.getElementById("filesList");if(0===selectedFiles.length){e.classList.add("hidden"),e.innerHTML="";return}e.classList.remove("hidden"),e.innerHTML=`
    <div class="p-3 bg-gray-50 dark:bg-gray-800 rounded-md">
      <div class="font-semibold text-sm mb-2">Selected Files (${selectedFiles.length}):</div>
      <div class="space-y-2">
        ${selectedFiles.map((e,t)=>`
          <div class="flex items-center justify-between p-2 bg-white dark:bg-gray-700 rounded border dark:border-gray-600 text-sm">
            <span class="flex-1 truncate" title="${e.name}">${e.name}</span>
            <span class="text-xs text-gray-500 dark:text-gray-400 mx-2">${formatFileSize(e.size)}</span>
            <button type="button" onclick="removeFile(${t})" class="text-red-500 hover:text-red-700 font-bold">✕</button>
          </div>
        `).join("")}
      </div>
    </div>
  `},removeFile=e=>{selectedFiles.splice(e,1),displayFilesList();let t=new DataTransfer;selectedFiles.forEach(e=>t.items.add(e)),document.getElementById("files").files=t.files},formatFileSize=e=>{if(0===e)return"0 Bytes";let t=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(e)/Math.log(1024));return Math.round(e/Math.pow(1024,s)*100)/100+" "+t[s]},updateUploadProgress=(e,t,s,l=null)=>{let d=document.getElementById(`progress-bar-${e}`),a=document.getElementById(`status-${e}`);d&&(d.style.width=t+"%",d.textContent=t+"%"),a&&(a.textContent=s,!0===l?(a.classList.remove("text-gray-600","dark:text-gray-400"),a.classList.add("text-green-600","dark:text-green-400")):!1===l&&(a.classList.remove("text-gray-600","dark:text-gray-400"),a.classList.add("text-red-600","dark:text-red-400")))},sendSummaryEmail=async(e,t,s,l,d,a,r)=>{let i={fullName:e,email:t,fileType:s,moduleName:l,grade:d,semester:a,fileName:`${r.length} file(s) uploaded`,fileData:"summary-email-trigger",mimeType:"text/plain",sendEmail:!0,uploadedFiles:r};try{await fetch(GAS_UPLOAD_URL,{method:"POST",body:JSON.stringify(i)})}catch(o){}},readFileAsBase64=e=>new Promise((t,s)=>{let l=new FileReader;l.onload=e=>{let s=e.target.result.split(",")[1];t(s)},l.onerror=e=>s(e),l.readAsDataURL(e)}),showUploadMessage=(e,t)=>{let s=document.getElementById("uploadResponseMessage");s.textContent=e,s.classList.remove("hidden","bg-green-100","text-green-800","border-green-200","bg-red-100","text-red-800","border-red-200"),s.classList.remove("dark:bg-green-900","dark:text-green-200","dark:border-green-800","dark:bg-red-900","dark:text-red-200","dark:border-red-800"),"success"===t?(s.classList.add("bg-green-100","text-green-800","border","border-green-200","dark:bg-green-900","dark:text-green-200","dark:border-green-800"),setTimeout(()=>{s.classList.add("hidden")},5e3)):s.classList.add("bg-red-100","text-red-800","border","border-red-200","dark:bg-red-900","dark:text-red-200","dark:border-red-800")};document.addEventListener("DOMContentLoaded",()=>{initUploadForm()});
