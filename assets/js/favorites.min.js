const FAVORITES_KEY="csbouira_favorites",getFavorites=()=>{try{return JSON.parse(localStorage.getItem(FAVORITES_KEY))||{}}catch{return{}}},saveFavorites=e=>{localStorage.setItem(FAVORITES_KEY,JSON.stringify(e))},getFavoriteKey=e=>e.path||`${e.year}>${e.name}`,isFavorite=e=>{let t=getFavorites();return!!t[e]},toggleFavorite=e=>{let t=getFavorites(),a=getFavoriteKey(e);return t[a]?delete t[a]:t[a]={type:e.type,name:e.name,path:a,year:e.year,folderPath:e.folderPath||[],link:e.link||"",previewLink:e.previewLink||"",downloadLink:e.downloadLink||"",addedAt:Date.now()},saveFavorites(t),renderFavoritesSection(),!!t[a]},removeFavorite=e=>{let t=getFavorites();delete t[e],saveFavorites(t),renderFavoritesSection()},clearAllFavorites=()=>{localStorage.removeItem(FAVORITES_KEY),renderFavoritesSection()},renderFavoritesSection=()=>{let e=document.getElementById("favorites-container");if(!e)return;let t=getFavorites(),a=Object.values(t),r=document.getElementById("favorites");if(0===a.length){r.style.display="none";return}r.style.display="";let o={};a.sort((e,t)=>(t.addedAt||0)-(e.addedAt||0)).forEach(e=>{let t=e.year||"Other";o[t]||(o[t]=[]),o[t].push(e)});let i=`
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-6">
      <h2 class="text-3xl font-bold flex items-center justify-center sm:justify-start gap-3 text-center sm:text-left">
        <i class="fas fa-star text-yellow-500"></i>
        My Favorites
      </h2>
      <button
        onclick="clearAllFavorites()"
        class="text-sm px-3 py-1.5 rounded-md transition self-center sm:self-auto"
        style="background: var(--bg-secondary-light); border: 1px solid var(--border-light); color: var(--text-secondary-light);"
        onmouseover="this.style.borderColor='#ef4444'; this.style.color='#ef4444';"
        onmouseout="this.style.borderColor='var(--border-light)'; this.style.color='var(--text-secondary-light)';"
      >
        <i class="fas fa-trash-alt mr-1"></i> Clear All
      </button>
    </div>
  `;for(let[s,l]of Object.entries(o)){for(let n of(i+=`
      <div class="mb-6">
        <h3 class="text-lg font-semibold mb-3 text-blue-500 flex items-center gap-2">
          <i class="fas fa-graduation-cap"></i> ${s}
        </h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
    `,l)){let d="folder"===n.type?"fas fa-folder text-yellow-500":getFavFileIcon(n.name),f=n.path.replace(/'/g,"\\'").replace(/"/g,"&quot;");i+=`
        <div class="favorite-card card p-4 cursor-pointer group relative" style="transform: none;">
          <div class="flex items-start gap-3">
            <i class="${d} text-xl mt-0.5 flex-shrink-0"></i>
            <div class="flex-1 min-w-0">
              <p class="font-medium text-sm truncate" title="${n.name}">${n.name}</p>
              <p class="text-xs mt-1" style="color: var(--text-secondary-light);">
                ${"folder"===n.type?"Folder":"File"}
                ${n.folderPath&&n.folderPath.length>1?" \xb7 "+n.folderPath.slice(1).join(" / "):""}
              </p>
            </div>
            <button
              onclick="event.stopPropagation(); removeFavorite('${f}');"
              class="favorite-remove-btn opacity-0 group-hover:opacity-100 text-gray-400 hover:text-red-500 transition-all p-1"
              title="Remove from favorites"
            >
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="favorite-card-actions mt-3 pt-3 flex gap-2" style="border-top: 1px solid var(--border-light);">
            ${"file"===n.type?`
              <button onclick="event.stopPropagation(); openFavoriteFile(${JSON.stringify(n).replace(/"/g,"&quot;")});"
                class="flex-1 text-xs py-1.5 rounded-md transition font-medium"
                style="background: var(--primary); color: white;">
                <i class="fas fa-eye mr-1"></i> View
              </button>
              ${n.downloadLink?`
              <button onclick="event.stopPropagation(); downloadFile('${n.downloadLink}', '${n.name.replace(/'/g,"\\'")}');"
                class="text-xs py-1.5 px-3 rounded-md transition font-medium"
                style="background: var(--bg-light); border: 1px solid var(--border-light);">
                <i class="fas fa-download"></i>
              </button>`:""}
            `:`
              <button onclick="event.stopPropagation(); openFavoriteFolder(${JSON.stringify(n).replace(/"/g,"&quot;")});"
                class="flex-1 text-xs py-1.5 rounded-md transition font-medium"
                style="background: var(--primary); color: white;">
                <i class="fas fa-folder-open mr-1"></i> Open
              </button>
            `}
          </div>
        </div>
      `}i+=`
        </div>
      </div>
    `}e.innerHTML=i},getFavFileIcon=e=>{let t=(e||"").split(".").pop().toLowerCase(),a={pdf:"fas fa-file-pdf text-red-500",doc:"fas fa-file-word text-blue-600",docx:"fas fa-file-word text-blue-600",ppt:"fas fa-file-powerpoint text-orange-500",pptx:"fas fa-file-powerpoint text-orange-500",xls:"fas fa-file-excel text-green-500",xlsx:"fas fa-file-excel text-green-500",zip:"fas fa-file-archive text-purple-500",rar:"fas fa-file-archive text-purple-500",png:"fas fa-file-image text-yellow-500",jpg:"fas fa-file-image text-yellow-500",jpeg:"fas fa-file-image text-yellow-500"};return a[t]||"fas fa-file text-gray-500"},openFavoriteFile=e=>{e.previewLink?(document.getElementById("modalTitle").textContent=e.name,document.getElementById("fileViewer").src=e.previewLink,document.getElementById("fileModal").classList.add("active"),updateBodyScrollLock()):e.link&&window.open(e.link,"_blank")},openFavoriteFolder=async e=>{if(e.year){currentYear=e.year,currentPath=e.folderPath?[...e.folderPath]:[e.year];let t=document.getElementById("yearModalTitle");t.innerHTML=`
      <div class="flex items-center gap-3">
        <span class="text-xl font-semibold">${e.year}</span>
        <a
          href="#"
          id="driveLink"
          title="Open in Google Drive"
          class="hidden sm:inline-flex items-center gap-1.5
                 px-2.5 py-1 text-xs
                 sm:gap-2 sm:px-3 sm:py-1.5 sm:text-sm
                 rounded-md bg-blue-500
                 text-white font-medium shadow-md
                 hover:shadow-lg hover:opacity-90 transition-all duration-200"
        >
          <i class="fab fa-google-drive text-base sm:text-lg"></i>
          <span class="hidden xs:inline sm:inline">Open in Drive</span>
        </a>
      </div>
    `,document.getElementById("yearModal").classList.add("active"),updateBodyScrollLock();let a=currentPath.join(">subfolders>");await loadContent(currentYear,a)}},createStarButton=e=>{let t=getFavoriteKey(e),a=isFavorite(t);return`
    <button
      onclick="event.stopPropagation(); handleStarClick(this, ${JSON.stringify(e).replace(/"/g,"&quot;")});"
      class="star-btn ${a?"starred":""}"
      title="${a?"Remove from favorites":"Add to favorites"}"
    >
      <i class="fa${a?"s":"r"} fa-star"></i>
    </button>
  `},handleStarClick=(e,t)=>{let a=toggleFavorite(t);e.classList.toggle("starred",a),e.title=a?"Remove from favorites":"Add to favorites";let r=e.querySelector("i");r.className=a?"fas fa-star":"far fa-star",e.classList.add("star-pulse"),setTimeout(()=>e.classList.remove("star-pulse"),300)};document.addEventListener("DOMContentLoaded",()=>{renderFavoritesSection()});
